---
title: "Task2"
author: "Samantha Kuglen"
date: "2/6/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(broom)
```

### A. Overview
The purpose of this code is to utilize non linear least squares to estimate parameters of a length to weight model for lizard populations in New Mexico.


**Data Citation**: 

### B. Data and Analysis
```{r}
lizards <- read_csv(here("data", "lizard.csv")) %>% 
    mutate(sex = case_when(sex == 'F' ~ 'Female',
                         sex == 'M' ~ 'Male')) %>% 
  clean_names()
```

#### I. Snout Length to Weight Model 

**Equation**
\[W = a(SVL)^b\]

```{r}
# model function
weight_function <- function(a, sv_length, b) {
  weight = a * (sv_length)^b
  return(weight)
}

# log transform the data
lizards_log <- lizards %>% 
  mutate(log_weight = log(weight)) %>% 
  mutate(log_length = log(sv_length))

# standard OLS regression on log transformed data

guess_model <- lm(log_weight ~ log_length, data = lizards_log)
tidy_guess_model <- tidy(guess_model)

# Using coefficients function, supply nls start list with regression coefficients
coef <- coefficients(guess_model)

# Mathematically transform intercept coefficient to get guess for parameter a

lizards_nls <- nls(weight ~ weight_function(a, sv_length, b),
                  data = lizards,
                  start = list(
                    a = 2.718^(coef[1]/coef[2]),
                    b = coef[2]),
                    trace = TRUE)

tidy_nls_table <- tidy(lizards_nls) %>% 
  select(-statistic) %>% 
  mutate(p.value = ifelse(p.value < 0.001, "< 0.001"))

kable(tidy_nls_table,
      col = c("Parameter", "Estimate", "Std Error", "p-value"), digits = 5) %>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = FALSE)

model_fitted <- lizards_nls %>% 
  broom::augment(type.predict = "response")

```
Regression coefficients: Intercept of the initial guess model is `r round(tidy_guess_model$estimate[1],3)`
- The log_length of `guess_model` is `r round(tidy_guess_model$estimate[2],3)`

### II. Fitted Model Plot By Sex 

```{r}

ggplot(lizards, aes(x = sv_length, y = weight, color = sex)) + 
  geom_point(aes(x = sv_length, y = weight, color = sex)) +
  geom_line(data = model_fitted, aes(x = sv_length, y = .fitted, color = "Model Predictions"))

```
### III. NLS Model for SubsetL of Male Western Whiptail lizard (Cnemidophorus tigrisatus)
Compare the output from the species specific nls model to the general nls model for all species by graphing the model fits on the Western Whiptail male data. 
```{r}
whiptail <- lizards %>% 
  filter(spp == "CNTI" & sex == "Male")

# log transform the data again
whip_log <- whiptail %>% 
  mutate(log_weight = log(weight)) %>% 
  mutate(log_length = log(sv_length))

# standard OLS regression on log transformed data
whip_model <- lm(log_weight ~ log_length, data = whip_log)
tidy_whip_model <- tidy(whip_model)

# Using coefficients function, supply nls start list with regression coefficients
whip_coef <- coefficients(whip_model)

# Mathematically transform intercept coefficient to get guess for parameter a

whip_nls <- nls(weight ~ weight_function(a, sv_length, b),
                  data = lizards,
                  start = list(
                    a = 2.718^(coef[1]/coef[2]),
                    b = whip_coef[2]),
                    trace = TRUE)

whip_tidy_nls_table <- tidy(whip_nls) %>% 
  select(-statistic) %>% 
  mutate(p.value = ifelse(p.value < 0.001, "< 0.001"))

kable(whip_tidy_nls_table,
      col = c("Parameter", "Estimate", "Std Error", "p-value"), digits = 5) %>% 
  kable_styling(bootstrap_options = "striped", 
                full_width = FALSE)

whip_model_fitted <- whip_nls %>% 
  broom::augment(type.predict = "response")
```

